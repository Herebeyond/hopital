{% extends 'base.html.twig' %}

{% block title %}Détails Donneur - {{ donneur.id_donneur }}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="h2"><i class="fas fa-hand-holding-heart"></i> Dossier Donneur</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ path('medical_dashboard') }}">Tableau de bord</a></li>
                    <li class="breadcrumb-item"><a href="{{ path('medical_donneurs') }}">Donneurs</a></li>
                    <li class="breadcrumb-item active">{{ donneur.id_donneur }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-6 text-end">
            {% if is_granted('ROLE_DOCTOR') %}
            <button class="btn btn-warning me-2" disabled title="Fonctionnalité à venir">
                <i class="fas fa-edit"></i> Modifier
            </button>
            {% endif %}
            {% if is_granted('ROLE_ADMIN') %}
            <button class="btn btn-danger me-2" disabled title="Fonctionnalité à venir">
                <i class="fas fa-trash"></i> Supprimer
            </button>
            {% endif %}
            <a href="{{ path('medical_donneurs') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour à la liste
            </a>
        </div>
    </div>

    {# General Information #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informations Générales</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">ID Donneur:</th>
                            <td><strong>{{ donneur.id_donneur }}</strong></td>
                        </tr>
                        <tr>
                            <th>N° Cristal:</th>
                            <td><span class="badge bg-secondary">{{ donneur.N_Cristal }}</span></td>
                        </tr>
                        <tr>
                            <th>Type:</th>
                            <td>
                                {% if donneur_vivant %}
                                    <span class="badge bg-info">Donneur Vivant</span>
                                {% elseif donneur_decede %}
                                    <span class="badge bg-secondary">Donneur Décédé</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Groupe Sanguin:</th>
                            <td>
                                {% if donneur.G_sanguin %}
                                    <span class="badge bg-danger fs-6">{{ donneur.G_sanguin }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Sexe:</th>
                            <td>
                                {% if donneur.Sexe == 1 %}
                                    <i class="fas fa-mars text-primary"></i> Homme
                                {% elseif donneur.Sexe == 0 %}
                                    <i class="fas fa-venus text-danger"></i> Femme
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Âge/Date:</th>
                            <td>{{ donneur.Age|date('d/m/Y') }}</td>
                        </tr>
                        <tr>
                            <th>Poids:</th>
                            <td>{{ donneur.Poids }}</td>
                        </tr>
                        {% if donneur.Commentaire_patient %}
                        <tr>
                            <th>Commentaire:</th>
                            <td><small>{{ donneur.Commentaire_patient }}</small></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            {% if donneur_vivant %}
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-heartbeat"></i> Spécifique Donneur Vivant</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Nom:</th>
                            <td>{{ donneur_vivant.Nom }}</td>
                        </tr>
                        <tr>
                            <th>Prénom:</th>
                            <td>{{ donneur_vivant.Prenom }}</td>
                        </tr>
                        <tr>
                            <th>Lien de Parenté:</th>
                            <td><span class="badge bg-info">{{ donneur_vivant.Lib_Lien }}</span></td>
                        </tr>
                        <tr>
                            <th>IMC:</th>
                            <td>{{ donneur_vivant.IMC }}</td>
                        </tr>
                        <tr>
                            <th>Créatinine:</th>
                            <td>{{ donneur_vivant.Creatinine }}</td>
                        </tr>
                        <tr>
                            <th>Clairance Calculée:</th>
                            <td>{{ donneur_vivant.Clairance_calculee }}</td>
                        </tr>
                        <tr>
                            <th>Clairance Isotopique:</th>
                            <td>{{ donneur_vivant.Clairance_isotopique }}</td>
                        </tr>
                        <tr>
                            <th>Protéinurie:</th>
                            <td>{{ donneur_vivant.Proténurie }}</td>
                        </tr>
                        <tr>
                            <th>Voie d'Abord:</th>
                            <td>{{ donneur_vivant.Lib_voie }}</td>
                        </tr>
                        <tr>
                            <th>Chirurgie Robotique:</th>
                            <td>
                                {% if donneur_vivant.Robot %}
                                    <span class="badge bg-success">Oui</span>
                                {% else %}
                                    <span class="badge bg-secondary">Non</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% elseif donneur_decede %}
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-cross"></i> Spécifique Donneur Décédé</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Cause Décès:</th>
                            <td><span class="badge bg-dark">{{ donneur_decede.Lib_deces }}</span></td>
                        </tr>
                        <tr>
                            <th>Ville d'Origine:</th>
                            <td>{{ donneur_decede.Ville_origine }}</td>
                        </tr>
                        <tr>
                            <th>Critères Étendus:</th>
                            <td>
                                {% if donneur_decede.Donneur_criteres_etendus %}
                                    <span class="badge bg-warning">Oui</span>
                                {% else %}
                                    <span class="badge bg-secondary">Non</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Arrêt Cardiaque:</th>
                            <td>
                                {% if donneur_decede.Arret_cardiaque %}
                                    <span class="badge bg-danger">Oui</span>
                                {% else %}
                                    <span class="badge bg-success">Non</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Durée Cardiaque:</th>
                            <td>{{ donneur_decede.Duree_cardiaque }}</td>
                        </tr>
                        <tr>
                            <th>PA Moyenne:</th>
                            <td>{{ donneur_decede.PA_moyenne }}</td>
                        </tr>
                        <tr>
                            <th>Créatinine Arrivée:</th>
                            <td>{{ donneur_decede.Creatinine_arrive }}</td>
                        </tr>
                        <tr>
                            <th>Créatinine Prélèvement:</th>
                            <td>{{ donneur_decede.Creatinine_prelevement }}</td>
                        </tr>
                        <tr>
                            <th>DFG:</th>
                            <td>{{ donneur_decede.DFG }}</td>
                        </tr>
                        {% if donneur_decede.Commentaire_deces %}
                        <tr>
                            <th>Commentaire:</th>
                            <td><small>{{ donneur_decede.Commentaire_deces }}</small></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {# HLA Typing #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dna"></i> Typage HLA</h5>
                </div>
                <div class="card-body">
                    {% if hla_typing|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Groupe HLA</th>
                                    <th>Valeur</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for hla in hla_typing %}
                                <tr>
                                    <td><strong>{{ hla.Libelle_groupe_HLA }}</strong></td>
                                    <td><span class="badge bg-success">{{ hla.Libelle_valeur_HLA }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">Aucun typage HLA enregistré</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-vial"></i> Sérologies</h5>
                </div>
                <div class="card-body">
                    {% if serologies|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Test</th>
                                    <th>Résultat</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sero in serologies %}
                                <tr>
                                    <td><strong>{{ sero.Libelle_serologie }}</strong></td>
                                    <td><span class="badge bg-warning text-dark">{{ sero.Libelle_valeur_serologie }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">Aucune sérologie enregistrée</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Associated Transplants #}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-heart"></i> Greffes Associées</h5>
                </div>
                <div class="card-body">
                    {% if greffes|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID Greffe</th>
                                    <th>Date</th>
                                    <th>Patient</th>
                                    <th>N° Dossier</th>
                                    <th>Type</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for greffe in greffes %}
                                <tr>
                                    <td><strong>#{{ greffe.id_greffon }}</strong></td>
                                    <td>{{ greffe.Date_greffe|date('d/m/Y') }}</td>
                                    <td>{{ greffe.patient_nom }} {{ greffe.patient_prenom }}</td>
                                    <td>{{ greffe.Ndossier }}</td>
                                    <td>{{ greffe.Type_greffe }}</td>
                                    <td>
                                        {% if greffe.Greffon_fonctionnel %}
                                            <span class="badge bg-success">Fonctionnel</span>
                                        {% else %}
                                            <span class="badge bg-danger">Non fonctionnel</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ path('medical_greffe_detail', {id: greffe.id_greffon}) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> Détails
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> Aucune greffe associée à ce donneur
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
